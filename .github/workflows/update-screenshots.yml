name: Update Screenshots

on:
  workflow_dispatch:
  deployment_status:
    state: success

jobs:
  update-screenshots:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Get branch name
        run: |
          BRANCH_NAME=$(git rev-parse HEAD | xargs git name-rev | cut -d' ' -f2 | sed 's/remotes\/origin\///g')

          if [ -z "$BRANCH_NAME" ]; then
            echo "Branch name not found. Exiting."
            exit 1
          fi

          echo "Branch name: $BRANCH_NAME"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Get deployment URL from GitHub API
        run: |
          if [ -z "${{ github.repository }}" ]; then
            echo "github.repository is not set. Exiting."
            exit 1
          fi

          REPO_INFO=$(curl -s -L \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            ${{ github.api_url }}/repos/${{ github.repository }})

          if [ $? -ne 0 ]; then
            echo "Failed to fetch repository information."
            exit 1
          fi

          DEPLOYMENT_URL=$(echo $REPO_INFO | jq -r .homepage)
          if [ "$DEPLOYMENT_URL" == "null" ]; then
            echo "No homepage URL found in repository."
            exit 1
          fi

          echo "Deployment URL: $DEPLOYMENT_URL"
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: |
          npm install puppeteer

      - name: Take screenshots
        run: |
          node scripts/take_screenshots.js $DEPLOYMENT_URL

      - name: Commit and push updated screenshots
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if [[ `git status --porcelain` ]]; then
            git add screenshot-*
            git commit -m "Update screenshots"
            git push origin $BRANCH_NAME
          else
            echo "No changes to commit."
          fi
